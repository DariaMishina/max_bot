name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."

            PROJECT_DIR="$HOME/max_bot"
            if [ ! -d "$PROJECT_DIR" ]; then
              PROJECT_DIR="/home/${{ secrets.SSH_USER }}/max_bot"
            fi

            if [ ! -d "$PROJECT_DIR" ]; then
              echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              exit 1
            fi

            cd "$PROJECT_DIR"
            echo "üìÇ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

            if [ ! -d "venv" ]; then
              echo "üì¶ –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
              python3 -m venv venv
            fi
            source venv/bin/activate

            echo "üîÑ –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git..."
            git fetch origin
            git reset --hard origin/main

            echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet

            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å..."
            sudo systemctl restart max-bot.service

            echo "‚è≥ –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã..."
            sleep 3

            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞..."
            sudo systemctl status max-bot.service --no-pager -l || true

            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
            tail -n 20 bot.log 2>/dev/null || echo "–õ–æ–≥ —Ñ–∞–π–ª –ø–æ–∫–∞ –ø—É—Å—Ç"

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
