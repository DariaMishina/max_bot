"""
Данные и утилиты для гексаграмм Ицзин — адаптировано для Max (aiomax).
"""
import random
import os
import logging
from typing import List, Dict

import aiomax

# Словарь с гексаграммами Ицзин и их значениями (64 гексаграммы)
HEXAGRAMS = {
    "1": {"name": "Цянь (Творчество)", "meaning": "Творческая сила, небо, инициатива, сила воли, лидерство"},
    "2": {"name": "Кунь (Исполнение)", "meaning": "Восприимчивость, земля, терпение, поддержка, материнство"},
    "3": {"name": "Чжунь (Начальная трудность)", "meaning": "Начало, трудности, рост, преодоление препятствий"},
    "4": {"name": "Мэн (Невежество юности)", "meaning": "Невежество, обучение, воспитание, развитие"},
    "5": {"name": "Сюй (Ожидание)", "meaning": "Ожидание, терпение, подготовка, готовность к действию"},
    "6": {"name": "Сун (Раздор)", "meaning": "Конфликт, спор, разногласия, необходимость примирения"},
    "7": {"name": "Ши (Войско)", "meaning": "Дисциплина, организация, порядок, коллективные действия"},
    "8": {"name": "Би (Приближение)", "meaning": "Единство, союз, сотрудничество, поддержка"},
    "9": {"name": "Сяо Сюй (Воспитание малым)", "meaning": "Малые препятствия, накопление сил, терпение"},
    "10": {"name": "Ли (Наступление)", "meaning": "Такт, осторожность, правильное поведение, следование пути"},
    "11": {"name": "Тай (Мир)", "meaning": "Гармония, процветание, благоприятный период, равновесие"},
    "12": {"name": "Пи (Упадок)", "meaning": "Застой, разобщенность, необходимость перемен"},
    "13": {"name": "Тун Жэнь (Единение людей)", "meaning": "Единство, дружба, сотрудничество, общие цели"},
    "14": {"name": "Да Ю (Великое обладание)", "meaning": "Изобилие, богатство, успех, щедрость"},
    "15": {"name": "Цянь (Скромность)", "meaning": "Скромность, смирение, равновесие, умеренность"},
    "16": {"name": "Юй (Восторг)", "meaning": "Радость, энтузиазм, вдохновение, гармония"},
    "17": {"name": "Суй (Последование)", "meaning": "Следование, адаптация, гибкость, принятие изменений"},
    "18": {"name": "Гу (Работа над испорченным)", "meaning": "Исправление, восстановление, исцеление, реформа"},
    "19": {"name": "Линь (Приближение)", "meaning": "Приближение, наблюдение, контроль, управление"},
    "20": {"name": "Гуань (Созерцание)", "meaning": "Созерцание, наблюдение, размышление, понимание"},
    "21": {"name": "Ши Хэ (Стиснутые зубы)", "meaning": "Решение проблем, преодоление препятствий, решимость"},
    "22": {"name": "Би (Украшение)", "meaning": "Красота, украшение, культура, эстетика"},
    "23": {"name": "Бо (Разрушение)", "meaning": "Разрушение, упадок, необходимость обновления"},
    "24": {"name": "Фу (Возврат)", "meaning": "Возврат, возрождение, новый цикл, восстановление"},
    "25": {"name": "У Ван (Невинность)", "meaning": "Невинность, спонтанность, естественность, искренность"},
    "26": {"name": "Да Чу (Воспитание великим)", "meaning": "Накопление, подготовка, большие силы, терпение"},
    "27": {"name": "И (Углы рта)", "meaning": "Питание, забота, поддержка, обеспечение"},
    "28": {"name": "Да Го (Переполнение великого)", "meaning": "Кризис, переполнение, необходимость изменений"},
    "29": {"name": "Кань (Погружение)", "meaning": "Опасность, глубина, преодоление трудностей, настойчивость"},
    "30": {"name": "Ли (Сияние)", "meaning": "Свет, ясность, понимание, привязанность"},
    "31": {"name": "Сянь (Влияние)", "meaning": "Взаимодействие, влияние, чувствительность, отклик"},
    "32": {"name": "Хэн (Постоянство)", "meaning": "Постоянство, выносливость, стабильность, настойчивость"},
    "33": {"name": "Дунь (Бегство)", "meaning": "Отступление, уход, сохранение сил, стратегическое отступление"},
    "34": {"name": "Да Чжуан (Мощь великого)", "meaning": "Сила, мощь, решительность, продвижение"},
    "35": {"name": "Цзинь (Восход)", "meaning": "Прогресс, продвижение, успех, развитие"},
    "36": {"name": "Мин И (Затмение света)", "meaning": "Скрытность, осторожность, защита, выживание"},
    "37": {"name": "Цзя Жэнь (Домашние)", "meaning": "Семья, дом, гармония в семье, внутренний порядок"},
    "38": {"name": "Куй (Разлад)", "meaning": "Разногласия, противоположности, необходимость примирения"},
    "39": {"name": "Цзянь (Препятствие)", "meaning": "Препятствие, трудность, необходимость обхода"},
    "40": {"name": "Цзе (Разрешение)", "meaning": "Освобождение, решение проблем, облегчение"},
    "41": {"name": "Сунь (Убыль)", "meaning": "Уменьшение, убыль, экономия, ограничение"},
    "42": {"name": "И (Приумножение)", "meaning": "Приумножение, рост, расширение, изобилие"},
    "43": {"name": "Гуай (Прорыв)", "meaning": "Прорыв, решительность, преодоление, решительные действия"},
    "44": {"name": "Гоу (Встреча)", "meaning": "Встреча, соединение, взаимодействие, возможность"},
    "45": {"name": "Цуй (Собирание)", "meaning": "Собирание, объединение, концентрация, накопление"},
    "46": {"name": "Шэн (Восхождение)", "meaning": "Восхождение, подъем, прогресс, развитие"},
    "47": {"name": "Кунь (Утесление)", "meaning": "Утеснение, ограничение, трудности, испытание"},
    "48": {"name": "Цзин (Колодец)", "meaning": "Колодец, источник, постоянство, питание"},
    "49": {"name": "Гэ (Переворот)", "meaning": "Переворот, революция, радикальные изменения"},
    "50": {"name": "Дин (Котел)", "meaning": "Котел, питание, трансформация, культура"},
    "51": {"name": "Чжэнь (Возбуждение)", "meaning": "Возбуждение, движение, пробуждение, активность"},
    "52": {"name": "Гэнь (Остановка)", "meaning": "Остановка, покой, размышление, стабильность"},
    "53": {"name": "Цзянь (Постепенность)", "meaning": "Постепенность, медленное развитие, терпение"},
    "54": {"name": "Гуй Мэй (Невеста)", "meaning": "Брак, союз, соединение, новые отношения"},
    "55": {"name": "Фэн (Изобилие)", "meaning": "Изобилие, полнота, успех, процветание"},
    "56": {"name": "Люй (Странник)", "meaning": "Странствие, путешествие, временность, адаптация"},
    "57": {"name": "Сунь (Кротость)", "meaning": "Кротость, проникновение, мягкость, гибкость"},
    "58": {"name": "Дуй (Радость)", "meaning": "Радость, удовольствие, общение, гармония"},
    "59": {"name": "Хуань (Рассеивание)", "meaning": "Рассеивание, освобождение, растворение, облегчение"},
    "60": {"name": "Цзе (Ограничение)", "meaning": "Ограничение, умеренность, дисциплина, контроль"},
    "61": {"name": "Чжун Фу (Внутренняя правда)", "meaning": "Искренность, правда, доверие, честность"},
    "62": {"name": "Сяо Го (Превышение малого)", "meaning": "Небольшое превышение, умеренность, осторожность"},
    "63": {"name": "Цзи Цзи (Уже конец)", "meaning": "Завершение, завершенность, порядок, успех"},
    "64": {"name": "Вэй Цзи (Еще не конец)", "meaning": "Незавершенность, переход, новый цикл, потенциал"}
}


def get_all_available_hexagrams() -> List[str]:
    """Получить список всех доступных гексаграмм из папки static/geks/"""
    hexagrams = []
    geks_dir = "static/geks"
    if os.path.exists(geks_dir):
        for filename in os.listdir(geks_dir):
            if filename.endswith(('.png', '.jpg', '.jpeg')):
                hexagram_id = filename.rsplit('.', 1)[0]
                if hexagram_id.isdigit() and 1 <= int(hexagram_id) <= 64:
                    hexagrams.append(hexagram_id)
    return sorted(hexagrams, key=int)


def get_hexagram_image_path(hexagram_id: str) -> str:
    """Получить путь к изображению гексаграммы"""
    geks_dir = "static/geks"
    for ext in ['.png', '.jpg', '.jpeg']:
        path = f"{geks_dir}/{hexagram_id}{ext}"
        if os.path.exists(path):
            return path
    return f"{geks_dir}/{hexagram_id}.png"


def get_hexagram_info(hexagram_id: str) -> Dict:
    """Получить информацию о гексаграмме из словаря"""
    return HEXAGRAMS.get(hexagram_id, {
        "name": f"Гексаграмма {hexagram_id}",
        "meaning": "Информация о гексаграмме недоступна"
    })


async def send_hexagram_image(bot: aiomax.Bot, chat_id: int, hexagram_id: str) -> None:
    """Отправить изображение гексаграммы в Max боте
    
    Args:
        bot: Экземпляр aiomax.Bot
        chat_id: ID чата для отправки
        hexagram_id: ID гексаграммы (номер от 1 до 64)
    """
    image_path = get_hexagram_image_path(hexagram_id)
    
    if not os.path.exists(image_path):
        logging.warning(f"Изображение гексаграммы {hexagram_id} не найдено по пути {image_path}")
        return
    
    try:
        attachment = await bot.upload_image(image_path)
        await bot.send_message(None, chat_id=chat_id, attachments=attachment)
    except Exception as e:
        logging.error(f"Ошибка отправки изображения гексаграммы {hexagram_id}: {e}", exc_info=True)
